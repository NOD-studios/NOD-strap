define(["can/util/library","can/map/bubble","can/map","can/list","can/map/nested_reference"],function(e,t){return e.LazyMap=e.Map.extend({_bubble:t},{setup:function(t){this.constructor.Map=this.constructor,this.constructor.List=e.LazyList,this._data=e.extend(e.extend(!0,{},this._setupDefaults()||{}),t),e.cid(this,".lazyMap"),this._init=1,this._computedBindings={},this._setupComputes();var s=t&&e.Map.helpers.addToMap(t,this);this._nestedReference=new e.NestedReference(this._data),s&&s(),e.each(this._data,e.proxy(function(e,t){this.___set(t,e)},this)),this.bind("change",e.proxy(this._changes,this)),delete this._init},_addChild:function(e,s,r){var a=this;if(this._nestedReference.removeChildren(e,function(r,i){if(t.remove(a,r),s){var n=i.replace(e+".","");if(e===n)r._nestedReference.each(function(e,r){s._nestedReference.make(r()),a._bindings&&t.add(this,s,r())});else{var p=s._nestedReference.make(n);a._bindings&&t.add(r,s,p())}}}),r&&r(),s){var i=this._nestedReference.make(e);this._bindings&&t.add(this,s,i())}return s},removeAttr:function(t){var s=this._goto(t);return s.parts.length?s.value.removeAttr(s.parts.join(".")):(e.isArray(s.parent)?(s.parent.splice(s.prop,1),this._triggerChange(t,"remove",void 0,[this.__type(s.value,s.prop)])):s.parent[s.prop]&&(delete s.parent[s.prop],e.batch.trigger(this,s.path.length?s.path.join(".")+".__keys":"__keys"),this._triggerChange(t,"remove",void 0,this.__type(s.value,s.prop))),this._nestedReference.removeChildren(),s.value)},__type:function(t){if(!(t instanceof e.LazyMap)&&e.Map.helpers.canMakeObserve(t)){if(e.isArray(t)){var s=e.LazyList;return new s(t)}var r=this.constructor.Map||e.LazyMap;return new r(t)}return t},_goto:function(t,s){for(var r,a,i=e.Map.helpers.attrParts(t,s).slice(0),n=[],p=this instanceof e.List?this[i.shift()]:this.__get();p&&!e.Map.helpers.isObservable(p)&&i.length;)void 0!==a&&n.push(a),r=p,p=p[a=i.shift()];return{parts:i,prop:a,value:p,parent:r,path:n}},_get:function(t){var s=this._goto(t);if(e.Map.helpers.isObservable(s.value))return s.parts.length?s.value._get(s.parts):s.value;if(s.value&&e.Map.helpers.canMakeObserve(s.value)){var r=this.__type(s.value,s.prop);return this._addChild(t,r,function(){s.parent[s.prop]=r}),r}return void 0!==s.value?s.value:this.__get(t)},_set:function(t,s,r){var a=this._goto(t,r);if(e.Map.helpers.isObservable(a.value)&&a.parts.length)return a.value._set(a.parts,s);if(a.parts.length)throw"can.LazyMap: object does not exist";this.__set(t,s,a.value,a)},__set:function(t,s,r,a,i){if(i=i||!0,s!==r){var n=a.parent.hasOwnProperty(a.prop)?"set":"add";if(i&&e.Map.helpers.canMakeObserve(s)){s=this.__type(s,t);var p=this;this._addChild(t,s,function(){p.___set(t,s,a)})}else this.___set(t,s,a);"add"===n&&e.batch.trigger(this,a.path.length?a.path.join(".")+".__keys":"__keys",void 0),this._triggerChange(t,n,s,r)}},___set:function(t,s,r){this[t]&&this[t].isComputed&&e.isFunction(this.constructor.prototype[t])?this[t](s):r?r.parent[r.prop]=s:this._data[t]=s,e.isFunction(this.constructor.prototype[t])||(this[t]=s)},_attrs:function(t,s){if(void 0===t)return e.Map.helpers.serialize(this,"attr",{});t=e.extend({},t);var r,a,i,n=this;e.batch.start(),this.each(function(r,p){return i=t[p],a=n._goto(p,!0),void 0===i?void(s&&n.removeAttr(p)):(!e.Map.helpers.isObservable(r)&&e.Map.helpers.canMakeObserve(r)&&(r=n.attr(p)),n.__convert&&(i=n.__convert(p,i)),i instanceof e.Map?n.__set(p,i,r,a):e.Map.helpers.isObservable(r)&&e.Map.helpers.canMakeObserve(i)&&r.attr?r.attr(i,s):r!==i&&n.__set(p,i,r,a),void delete t[p])});for(r in t)i=t[r],this._set(r,i,!0);return e.batch.stop(),this}}),e.LazyList=e.List.extend({Map:e.LazyMap},{setup:function(){e.List.prototype.setup.apply(this,arguments),this._nestedReference=new e.NestedReference(this)}}),e.LazyMap});
//# sourceMappingURL=lazy.js
//# sourceMappingURL=lazy.js.map