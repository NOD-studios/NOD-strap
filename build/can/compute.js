define(["can/util/library","can/util/bind","can/util/batch"],function(n){var e=[];n.__read=function(n,t){e.push({});var o=n.call(t);return{value:o,observed:e.pop()}},n.__reading=function(n,t){e.length&&(e[e.length-1][n._cid+"|"+t]={obj:n,event:t+""})},n.__clearReading=function(){if(e.length){var n=e[e.length-1];return e[e.length-1]={},n}},n.__setReading=function(n){e.length&&(e[e.length-1]=n)},n.__addReading=function(t){e.length&&n.simpleExtend(e[e.length-1],t)};var t=function(e,t,u,i){var c=n.__read(e,t),a=c.observed;return o(u,a,i),r(u,i),c},o=function(n,e,t){for(var o in e)u(n,e,o,t)},u=function(n,e,t,o){if(n[t])delete n[t];else{var u=e[t];u.obj.bind(u.event,o)}},r=function(n,e){for(var t in n){var o=n[t];o.obj.unbind(o.event,e)}},i=function(e,t,o,u){t!==o&&n.batch.trigger(e,u?{type:"change",batchNum:u}:"change",[t,o])},c=function(e,o,u,r){var i,c,a;return{on:function(f){c||(c=function(n){if(e.bound&&(void 0===n.batchNum||n.batchNum!==a)){var r=i.value;i=t(o,u,i.observed,c),f(i.value,r,n.batchNum),a=a=n.batchNum}}),i=t(o,u,{},c),r(i.value),e.hasDependencies=!n.isEmptyObject(i.observed)},off:function(){for(var n in i.observed){var e=i.observed[n];e.obj.unbind(e.event,c)}}}},a=function(e,o,u,r){var i,c,a,f;return{on:function(l){a||(a=function(t){if(e.bound&&(void 0===t.batchNum||t.batchNum!==f)){var r=n.__clearReading(),i=o.call(u);n.__setReading(r),l(i,c,t.batchNum),c=i,f=f=t.batchNum}}),i=t(o,u,{},a),c=i.value,r(i.value),e.hasDependencies=!n.isEmptyObject(i.observed)},off:function(){for(var n in i.observed){var e=i.observed[n];e.obj.unbind(e.event,a)}}}},f=function(e){return e instanceof n.Map||e&&e.__get},l=function(){};n.compute=function(t,o,u,r){if(t&&t.isComputed)return t;for(var f,d,s,v=l,b=l,p=function(){return d},h=function(n){d=n},g=h,m=[],_=function(n,e,t){g(n),i(f,n,e,t)},y=0,C=arguments.length;C>y;y++)m[y]=arguments[y];if(f=function(t){if(arguments.length){var u=d,r=h.call(o,t,u);return f.hasDependencies?p.call(o):(d=void 0===r?p.call(o):r,i(f,d,u),d)}return e.length&&f.canReadForChangeEvent!==!1&&(n.__reading(f,"change"),f.bound||n.compute.temporarilyBind(f)),f.bound?d:p.call(o)},"function"==typeof t){h=t,p=t,f.canReadForChangeEvent=u===!1?!1:!0;var x=r?a(f,t,o||this,g):c(f,t,o||this,g);v=x.on,b=x.off}else if(o)if("string"==typeof o){var O=o,E=t instanceof n.Map;if(E){f.hasDependencies=!0;var N;p=function(){return t.attr(O)},h=function(n){t.attr(O,n)},v=function(e){N=function(n,t,o){e(t,o,n.batchNum)},t.bind(u||O,N),d=n.__read(p).value},b=function(){t.unbind(u||O,N)}}else p=function(){return t[O]},h=function(n){t[O]=n},v=function(e){N=function(){e(p(),d)},n.bind.call(t,u||O,N),d=n.__read(p).value},b=function(){n.unbind.call(t,u||O,N)}}else if("function"==typeof o)d=t,h=o,o=u,s="setter";else{d=t;var j=o,R=_;if(o=j.context||j,p=j.get||p,h=j.set||function(){return d},j.fn){var A,D=j.fn;p=function(){return D.call(o,d)},0===D.length?A=c(f,D,o,g):1===D.length?A=c(f,function(){return D.call(o,d)},o,g):(_=function(n){void 0!==n&&R(n,d)},A=c(f,function(){var n=D.call(o,d,function(n){R(n,d)});return void 0!==n?n:d},o,g)),v=A.on,b=A.off}else _=function(){var n=p.call(o);R(n,d)};v=j.on||v,b=j.off||b}else d=t;return n.cid(f,"compute"),n.simpleExtend(f,{isComputed:!0,_bindsetup:function(){this.bound=!0;var e=n.__clearReading();v.call(this,_),n.__setReading(e)},_bindteardown:function(){b.call(this,_),this.bound=!1},bind:n.bindAndSetup,unbind:n.unbindAndTeardown,clone:function(e){return e&&("setter"===s?m[2]=e:m[1]=e),n.compute.apply(n,m)}})};var d,s=function(){for(var n=0,e=d.length;e>n;n++)d[n].unbind("change",l);d=null};return n.compute.temporarilyBind=function(n){n.bind("change",l),d||(d=[],setTimeout(s,10)),d.push(n)},n.compute.truthy=function(e){return n.compute(function(){var n=e();return"function"==typeof n&&(n=n()),!!n})},n.compute.async=function(e,t,o){return n.compute(e,{fn:t,context:o})},n.compute.read=function(e,t,o){o=o||{};for(var u,r,i,c=e,a=0,l=t.length;l>a;a++)if(r=c,r&&r.isComputed&&(o.foundObservable&&o.foundObservable(r,a),r=c=r()),f(r)?(!i&&o.foundObservable&&o.foundObservable(r,a),i=1,c="function"==typeof r[t[a]]&&r.constructor.prototype[t[a]]===r[t[a]]?o.returnObserveMethods?c[t[a]]:"constructor"===t[a]&&r instanceof n.Construct||r[t[a]].prototype instanceof n.Construct?r[t[a]]:r[t[a]].apply(r,o.args||[]):c.attr(t[a])):c=null==c?void 0:r[t[a]],u=typeof c,c&&c.isComputed&&!o.isArgument&&l-1>a?(!i&&o.foundObservable&&o.foundObservable(r,a+1),c=c()):a<t.length-1&&"function"===u&&o.executeAnonymousFunctions&&!(n.Construct&&c.prototype instanceof n.Construct)&&(c=c()),a<t.length-1&&(null===c||"function"!==u&&"object"!==u))return o.earlyExit&&o.earlyExit(r,a,c),{value:void 0,parent:r};return"function"!=typeof c||n.Construct&&c.prototype instanceof n.Construct||n.route&&c===n.route||(o.isArgument?c.isComputed||o.proxyMethods===!1||(c=n.proxy(c,r)):(c.isComputed&&!i&&o.foundObservable&&o.foundObservable(c,a),c=c.call(r))),void 0===c&&o.earlyExit&&o.earlyExit(r,a-1),{value:c,parent:r}},n.compute.set=function(n,e,t){return f(n)?n.attr(e,t):n[e]&&n[e].isComputed?n[e](t):void("object"==typeof n&&(n[e]=t))},n.compute});
//# sourceMappingURL=compute.js.map