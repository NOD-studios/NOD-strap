define(["can/util/library","can/view/parser","can/view/target","can/view/html_section","can/view/text_section","can/view/mustache_core","can/view/mustache_helpers","can/view/intermediate_and_imports","can/view/callbacks","can/view/bindings"],function(e,t,n,i,a,r,o,c,s){function d(n){"string"==typeof n&&(n=r.cleanLineEndings(n));var o=new i,c={node:null,attr:null,sectionElementStack:[],text:!1},d=function(e,t,n){if(">"===t)e.add(r.makeLiveBindingPartialRenderer(n,c));else if("/"===t)e.endSection(),e instanceof i&&c.sectionElementStack.pop();else if("else"===t)e.inverse();else{var a=e instanceof i?r.makeLiveBindingBranchRenderer:r.makeStringBranchRenderer;"{"===t||"&"===t?e.add(a(null,n,u())):"#"===t||"^"===t?(e.startSection(a(t,n,u())),e instanceof i&&c.sectionElementStack.push("section")):e.add(a(null,n,u({text:!0})))}},u=function(t){var n={tag:c.node&&c.node.tag,attr:c.attr&&c.attr.name,directlyNested:"section"===c.sectionElementStack[c.sectionElementStack.length-1]};return t?e.simpleExtend(n,t):n},l=function(e,t){e.attributes||(e.attributes=[]),e.attributes.push(t)};return t(n,{start:function(e){c.node={tag:e,children:[]}},end:function(e,t){var n=s.tag(e);t?(o.add(c.node),n&&l(c.node,function(t,n){s.tagHandler(this,e,{scope:t,options:n,subtemplate:null,templateType:"stache"})})):(o.push(c.node),c.sectionElementStack.push("element"),n&&o.startSubSection()),c.node=null},close:function(e){var t,n=s.tag(e);n&&(t=o.endSubSectionAndReturnRenderer());var i=o.pop();n&&l(i,function(n,i){s.tagHandler(this,e,{scope:n,options:i,subtemplate:t,templateType:"stache"})}),c.sectionElementStack.pop()},attrStart:function(e){c.node.section?c.node.section.add(e+'="'):c.attr={name:e,value:""}},attrEnd:function(e){if(c.node.section)c.node.section.add('" ');else{c.node.attrs||(c.node.attrs={}),c.node.attrs[c.attr.name]=c.attr.section?c.attr.section.compile(u()):c.attr.value;var t=s.attr(e);t&&(c.node.attributes||(c.node.attributes=[]),c.node.attributes.push(function(n,i){t(this,{attributeName:e,scope:n,options:i})})),c.attr=null}},attrValue:function(e){var t=c.node.section||c.attr.section;t?t.add(e):c.attr.value+=e},chars:function(e){o.add(e)},special:function(e){var t=r.splitModeFromExpression(e,c),n=t.mode,i=t.expression;if("else"===i)return void(c.attr&&c.attr.section?c.attr.section:o).inverse();if("!"!==n)if(c.node&&c.node.section)d(c.node.section,n,i),0===c.node.section.subSectionDepth()&&(c.node.attributes.push(c.node.section.compile(u())),delete c.node.section);else if(c.attr)c.attr.section||(c.attr.section=new a,c.attr.value&&c.attr.section.add(c.attr.value)),d(c.attr.section,n,i);else if(c.node)if(c.node.attributes||(c.node.attributes=[]),n){if("#"!==n&&"^"!==n)throw n+" is currently not supported within a tag.";c.node.section||(c.node.section=new a),d(c.node.section,n,i)}else c.node.attributes.push(r.makeLiveBindingBranchRenderer(null,i,u()));else d(o,n,i)},comment:function(e){o.add({comment:e})},done:function(){}}),o.compile()}t=t||e.view.parser,s=s||e.view.callbacks;var u={"\n":"\\n","\r":"\\r","\u2028":"\\u2028","\u2029":"\\u2029"},l=function(e){return(""+e).replace(/["'\\\n\r\u2028\u2029]/g,function(e){return"'\"\\".indexOf(e)>=0?"\\"+e:u[e]})};return e.view.register({suffix:"stache",contentType:"x-stache-template",fragRenderer:function(e,t){return d(t)},script:function(e,t){return'can.stache("'+l(t)+'")'}}),e.view.ext=".stache",e.extend(e.stache,o),e.extend(d,o),e.stache.safeString=d.safeString=function(e){return{toString:function(){return e}}},e.stache.async=function(t){var n=c(t),i=e.map(n.imports,function(t){return e["import"](t)});return e.when.apply(e,i).then(function(){return d(n.intermediate)})},d});
//# sourceMappingURL=stache.js
//# sourceMappingURL=stache.js.map