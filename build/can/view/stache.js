define(["can/util/library","can/view/parser","can/view/target","can/view/stache/html_section","can/view/stache/text_section","can/view/stache/mustache_core","can/view/stache/mustache_helpers","can/view/callbacks"],function(e,t,n,a,i,o,r,c){function s(n){n=o.cleanLineEndings(n);var r=new a,s={node:null,attr:null,sectionElementStack:[],text:!1},d=function(e,t,n){if(">"===t)e.add(o.makeLiveBindingPartialRenderer(n,s));else if("/"===t)e.endSection(),e instanceof a&&s.sectionElementStack.pop();else if("else"===t)e.inverse();else{var i=e instanceof a?o.makeLiveBindingBranchRenderer:o.makeStringBranchRenderer;"{"===t||"&"===t?e.add(i(null,n,u())):"#"===t||"^"===t?(e.startSection(i(t,n,u())),e instanceof a&&s.sectionElementStack.push("section")):e.add(i(null,n,u({text:!0})))}},u=function(t){var n={tag:s.node&&s.node.tag,attr:s.attr&&s.attr.name,directlyNested:"section"===s.sectionElementStack[s.sectionElementStack.length-1]};return t?e.simpleExtend(n,t):n},l=function(e,t){e.attributes||(e.attributes=[]),e.attributes.push(t)};return t(n,{start:function(e){s.node={tag:e,children:[]}},end:function(e,t){var n=c.tag(e);t?(r.add(s.node),n&&l(s.node,function(t,n){c.tagHandler(this,e,{scope:t,options:n,subtemplate:null,templateType:"stache"})})):(r.push(s.node),s.sectionElementStack.push("element"),n&&r.startSubSection()),s.node=null},close:function(e){var t,n=c.tag(e);n&&(t=r.endSubSectionAndReturnRenderer());var a=r.pop();n&&l(a,function(n,a){c.tagHandler(this,e,{scope:n,options:a,subtemplate:t,templateType:"stache"})}),s.sectionElementStack.pop()},attrStart:function(e){s.node.section?s.node.section.add(e+'="'):s.attr={name:e,value:""}},attrEnd:function(e){if(s.node.section)s.node.section.add('" ');else{s.node.attrs||(s.node.attrs={}),s.node.attrs[s.attr.name]=s.attr.section?s.attr.section.compile(u()):s.attr.value;var t=c.attr(e);t&&(s.node.attributes||(s.node.attributes=[]),s.node.attributes.push(function(n,a){t(this,{attributeName:e,scope:n,options:a})})),s.attr=null}},attrValue:function(e){var t=s.node.section||s.attr.section;t?t.add(e):s.attr.value+=e},chars:function(e){r.add(e)},special:function(e){var t=o.splitModeFromExpression(e,s),n=t.mode,a=t.expression;if("else"===a)return void(s.attr&&s.attr.section?s.attr.section:r).inverse();if("!"!==n)if(s.node&&s.node.section)d(s.node.section,n,a),0===s.node.section.subSectionDepth()&&(s.node.attributes.push(s.node.section.compile(u())),delete s.node.section);else if(s.attr)s.attr.section||(s.attr.section=new i,s.attr.value&&s.attr.section.add(s.attr.value)),d(s.attr.section,n,a);else if(s.node)if(s.node.attributes||(s.node.attributes=[]),n){if("#"!==n&&"^"!==n)throw n+" is currently not supported within a tag.";s.node.section||(s.node.section=new i),d(s.node.section,n,a)}else s.node.attributes.push(o.makeLiveBindingBranchRenderer(null,a,u()));else d(r,n,a)},comment:function(e){r.add({comment:e})},done:function(){}}),r.compile()}t=t||e.view.parser,c=c||e.view.callbacks;var d={"\n":"\\n","\r":"\\r","\u2028":"\\u2028","\u2029":"\\u2029"},u=function(e){return(""+e).replace(/["'\\\n\r\u2028\u2029]/g,function(e){return"'\"\\".indexOf(e)>=0?"\\"+e:d[e]})};return e.view.register({suffix:"stache",contentType:"x-stache-template",fragRenderer:function(e,t){return s(t)},script:function(e,t){return'can.stache("'+u(t)+'")'}}),e.view.ext=".stache",e.extend(e.stache,r),e.extend(s,r),e.stache.safeString=s.safeString=function(e){return{toString:function(){return e}}},s});
//# sourceMappingURL=stache.js.map